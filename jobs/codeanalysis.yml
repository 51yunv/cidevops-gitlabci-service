.code_analysis:
  variables:
    GLOBAL_PROJECT_ARGS: "-Dsonar.projectKey=${CI_PROJECT_NAME} 
                          -Dsonar.projectName=${CI_PROJECT_NAME} 
                          -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} 
                          -Dsonar.projectDescription=${CI_PROJECT_TITLE}"
    GLOBAL_SERVER_ARGS:  "-Dsonar.host.url=${SONAR_SERVER}
                          -Dsonar.login=${SONAR_USER}
                          -Dsonar.password=${SONAR_USER_PASSWORD}
                          -Dsonar.ws.timeout=30 
                          -Dsonar.links.homepage=${CI_PROJECT_URL} 
                          -Dsonar.sourceEncoding=UTF-8 "
    GLOBAL_MR_ARGS: "-Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} 
                     -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} 
                     -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME} 
                     -Dsonar.gitlab.ref_name=${CI_COMMIT_REF_NAME} 
                     -Dsonar.gitlab.commit_sha=${CI_COMMIT_SHA} 
                     -Dsonar.gitlab.project_id=${CI_PROJECT_PATH} 
                     -Dsonar.pullrequest.gitlab.repositorySlug=${CI_PROJECT_ID}"
    MULTI_BRANCH_ARGS: "-Dsonar.branch.name=${CI_COMMIT_REF_NAME}"
  stage: code_analysis
  tags:
  - k8s
  script:
  - echo ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${GLOBAL_MR_ARGS}
  - |
    if [ $CI_PIPELINE_SOURCE == 'merge_request_event' ] 
    
    then
       echo "sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} " 
       sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} 
    else 
       echo "sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${MULTI_BRANCH_ARGS}"
       sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS}  ${MULTI_BRANCH_ARGS}
    fi 
  rules:
  - if: " $RUN_CODE_ANALYSIS == 'no' "
    when: never
  - when: always